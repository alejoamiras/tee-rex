name: "Lint: Shell & Workflows"

on:
  workflow_dispatch:
  pull_request:
    branches: [main]

jobs:
  changes:
    name: Detect changes
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      workflows: ${{ steps.override.outputs.workflows || steps.filter.outputs.workflows }}
      shell: ${{ steps.override.outputs.shell || steps.filter.outputs.shell }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            workflows:
              - '.github/workflows/**'
              - '.github/actions/**'
            shell:
              - 'infra/**/*.sh'
      - name: Override for manual dispatch
        if: github.event_name == 'workflow_dispatch'
        id: override
        run: |
          echo "workflows=true" >> "$GITHUB_OUTPUT"
          echo "shell=true" >> "$GITHUB_OUTPUT"

  actionlint:
    name: Lint workflows
    needs: changes
    if: needs.changes.outputs.workflows == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - name: Download actionlint
        id: get_actionlint
        run: bash <(curl https://raw.githubusercontent.com/rhysd/actionlint/main/scripts/download-actionlint.bash)
        shell: bash
      - name: Run actionlint
        run: ${{ steps.get_actionlint.outputs.executable }} -color
        shell: bash

  shellcheck:
    name: Shellcheck
    needs: changes
    if: needs.changes.outputs.shell == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - name: Run shellcheck
        run: shellcheck infra/*.sh

  status:
    name: Actionlint Status
    if: always()
    needs: [changes, actionlint, shellcheck]
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - name: Check results
        run: |
          if [ "${{ needs.actionlint.result }}" = "failure" ]; then
            echo "Actionlint failed"
            exit 1
          fi
          if [ "${{ needs.shellcheck.result }}" = "failure" ]; then
            echo "Shellcheck failed"
            exit 1
          fi
          echo "All checks passed (or skipped â€” no relevant changes)"
