name: _TEE E2E (reusable)

on:
  workflow_call:
    inputs:
      aztec_version:
        description: Aztec CLI version
        required: true
        type: string
      ref:
        description: Git ref to checkout
        required: false
        type: string
        default: ""

jobs:
  e2e-tee:
    name: TEE E2E
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      id-token: write
      contents: read
    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      INSTANCE_ID: ${{ secrets.TEE_INSTANCE_ID }}
      ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}
      IMAGE_TAG: nightly
    steps:
      # ── Checkout ──────────────────────────────────────────────────
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || github.ref }}

      # ── AWS Credentials via OIDC ─────────────────────────────────
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      # ── Build & Push Docker Image ────────────────────────────────
      - name: Login to ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        run: |
          IMAGE="${ECR_REGISTRY}/tee-rex:${IMAGE_TAG}"
          docker build -f Dockerfile.nitro -t "${IMAGE}" .
          docker push "${IMAGE}"
          echo "IMAGE_URI=${IMAGE}" >> "$GITHUB_ENV"

      # ── Start EC2 Instance ───────────────────────────────────────
      - name: Start EC2 instance
        run: |
          echo "Starting instance ${INSTANCE_ID}..."
          aws ec2 start-instances --instance-ids "${INSTANCE_ID}"

          echo "Waiting for instance to be running..."
          aws ec2 wait instance-running --instance-ids "${INSTANCE_ID}"

          # Wait for SSM agent to come online
          echo "Waiting for SSM agent..."
          for i in $(seq 1 30); do
            STATUS=$(aws ssm describe-instance-information \
              --filters "Key=InstanceIds,Values=${INSTANCE_ID}" \
              --query 'InstanceInformationList[0].PingStatus' \
              --output text 2>/dev/null || echo "None")
            if [ "$STATUS" = "Online" ]; then
              echo "SSM agent online (attempt $i)"
              break
            fi
            if [ "$i" = "30" ]; then
              echo "SSM agent not online after 5 minutes"
              exit 1
            fi
            sleep 10
          done

          # Get public IP for TEE_URL
          PUBLIC_IP=$(aws ec2 describe-instances \
            --instance-ids "${INSTANCE_ID}" \
            --query 'Reservations[0].Instances[0].PublicIpAddress' \
            --output text)
          echo "TEE_URL=http://${PUBLIC_IP}:4000" >> "$GITHUB_ENV"
          echo "TEE instance: ${PUBLIC_IP}:4000"

      # ── Deploy Enclave via SSM ───────────────────────────────────
      - name: Deploy enclave
        run: |
          # Upload ci-deploy.sh via base64 to avoid SSM escaping issues
          SCRIPT_B64=$(base64 -w0 infra/ci-deploy.sh)

          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${INSTANCE_ID}" \
            --document-name "AWS-RunShellScript" \
            --timeout-seconds 600 \
            --parameters "commands=[
              \"echo '${SCRIPT_B64}' | base64 -d > /tmp/ci-deploy.sh\",
              \"chmod +x /tmp/ci-deploy.sh\",
              \"/tmp/ci-deploy.sh ${IMAGE_URI}\"
            ]" \
            --query 'Command.CommandId' \
            --output text)

          echo "SSM Command: ${COMMAND_ID}"
          echo "Waiting for enclave deployment..."

          for i in $(seq 1 120); do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "${COMMAND_ID}" \
              --instance-id "${INSTANCE_ID}" \
              --query 'Status' \
              --output text 2>/dev/null || echo "Pending")

            case "${STATUS}" in
              Success)
                echo "Enclave deployed successfully"
                aws ssm get-command-invocation \
                  --command-id "${COMMAND_ID}" \
                  --instance-id "${INSTANCE_ID}" \
                  --query 'StandardOutputContent' \
                  --output text | tail -20
                break
                ;;
              Failed|TimedOut|Cancelled)
                echo "Enclave deployment ${STATUS}"
                echo "=== stdout ==="
                aws ssm get-command-invocation \
                  --command-id "${COMMAND_ID}" \
                  --instance-id "${INSTANCE_ID}" \
                  --query 'StandardOutputContent' \
                  --output text | tail -30
                echo "=== stderr ==="
                aws ssm get-command-invocation \
                  --command-id "${COMMAND_ID}" \
                  --instance-id "${INSTANCE_ID}" \
                  --query 'StandardErrorContent' \
                  --output text | tail -30
                exit 1
                ;;
              *)
                if [ "$i" = "120" ]; then
                  echo "Timed out waiting for SSM command (10 min)"
                  exit 1
                fi
                sleep 5
                ;;
            esac
          done

      # ── Verify TEE Reachable from Runner ─────────────────────────
      - name: Verify TEE reachable
        run: |
          echo "Checking ${TEE_URL}/attestation..."
          for i in $(seq 1 12); do
            if curl -sf "${TEE_URL}/attestation" > /dev/null 2>&1; then
              echo "TEE server reachable from CI runner"
              curl -s "${TEE_URL}/attestation" | jq '{mode, hasDoc: (.attestationDocument != null)}'
              exit 0
            fi
            sleep 5
          done
          echo "TEE server not reachable at ${TEE_URL}"
          exit 1

      # ── Setup Aztec + Local Services ─────────────────────────────
      - uses: ./.github/actions/setup-aztec
        with:
          aztec_version: ${{ inputs.aztec_version }}

      - uses: ./.github/actions/start-services

      # ── Run SDK E2E with TEE_URL ─────────────────────────────────
      - name: SDK E2E (with TEE)
        env:
          TEE_URL: ${{ env.TEE_URL }}
        run: bun run --cwd packages/sdk test:e2e

      # ── Run Demo Fullstack E2E with TEE_URL ──────────────────────
      - name: Install Playwright browsers
        run: bunx playwright install --with-deps chromium

      - name: Demo Fullstack E2E (with TEE)
        env:
          TEE_URL: ${{ env.TEE_URL }}
        run: bun run --cwd packages/demo test:e2e:fullstack

      # ── Teardown: Always stop instance ───────────────────────────
      - name: Stop EC2 instance
        if: always()
        run: |
          if [ -n "${INSTANCE_ID}" ]; then
            aws ec2 stop-instances --instance-ids "${INSTANCE_ID}" || true
            echo "EC2 instance stop requested"
          fi
