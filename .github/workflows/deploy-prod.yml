name: Deploy Production

on:
  push:
    branches: [main]
    paths-ignore:
      - "**.md"
      - "lessons/**"
      - "**/e2e/**"
      - "**/*.test.ts"
      - "**/playwright.config.ts"
  workflow_dispatch:

concurrency:
  group: deploy-prod
  cancel-in-progress: false

permissions:
  id-token: write
  contents: write

jobs:
  # ── Detect which components changed ─────────────────────────────
  changes:
    name: Detect changes
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      servers: ${{ steps.override.outputs.servers || steps.filter.outputs.servers }}
      app: ${{ steps.override.outputs.app || steps.filter.outputs.app }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            servers:
              - 'packages/server/**'
              - 'packages/sdk/**'
              - 'Dockerfile'
              - 'Dockerfile.base'
              - 'Dockerfile.nitro'
              - 'infra/**'
              - '.github/workflows/_deploy-*.yml'
              - '.github/workflows/_build-*.yml'
              - '.github/workflows/deploy-prod.yml'
              - '.github/actions/**'
              - 'package.json'
              - 'bun.lock'
            app:
              - 'packages/app/**'
              - 'packages/sdk/**'
              - '.github/workflows/deploy-prod.yml'
              - 'package.json'
              - 'bun.lock'
      - name: Override for manual dispatch
        if: github.event_name == 'workflow_dispatch'
        id: override
        run: |
          echo "servers=true" >> "$GITHUB_OUTPUT"
          echo "app=true" >> "$GITHUB_OUTPUT"

  # ── Build base image (idempotent — skips if already in ECR) ─────
  ensure-base:
    name: Build Base Image
    needs: changes
    if: needs.changes.outputs.servers == 'true'
    uses: ./.github/workflows/_build-base.yml
    secrets: inherit

  # ── Deploy TEE enclave to production ─────────────────────────────
  deploy-tee:
    name: Deploy TEE (prod)
    needs: [changes, ensure-base]
    if: needs.changes.outputs.servers == 'true'
    uses: ./.github/workflows/_deploy-tee.yml
    secrets: inherit
    with:
      environment: prod
      image_tag: prod-tee
      base_tag: ${{ needs.ensure-base.outputs.base_tag }}

  # ── Deploy prover container to production ────────────────────────
  deploy-prover:
    name: Deploy Prover (prod)
    needs: [changes, ensure-base]
    if: needs.changes.outputs.servers == 'true'
    uses: ./.github/workflows/_deploy-prover.yml
    secrets: inherit
    with:
      environment: prod
      image_tag: prod-prover
      base_tag: ${{ needs.ensure-base.outputs.base_tag }}

  # ── Build & deploy app to S3 + invalidate CloudFront ────────────
  deploy-app:
    name: Deploy App (prod)
    needs: changes
    if: needs.changes.outputs.app == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build app
        run: bun run --cwd packages/app build
        env:
          AZTEC_NODE_URL: https://nextnet.aztec-labs.com
          PROVER_URL: ${{ secrets.PROD_CLOUDFRONT_URL }}/prover
          TEE_URL: ${{ secrets.PROD_CLOUDFRONT_URL }}/tee

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Deploy to S3
        run: |
          aws s3 sync packages/app/dist/ s3://${{ secrets.PROD_S3_BUCKET }}/ \
            --delete \
            --cache-control "max-age=31536000,immutable" \
            --exclude "index.html"

          aws s3 cp packages/app/dist/index.html s3://${{ secrets.PROD_S3_BUCKET }}/index.html \
            --cache-control "max-age=60"

      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.PROD_CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/index.html"

  # ── Nextnet connectivity check (gates SDK publish) ───────────────
  nextnet-check:
    name: Nextnet Smoke
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lock') }}
          restore-keys: ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run nextnet smoke tests
        run: bun run test:e2e:nextnet

  # ── Publish SDK to npm (spartan auto-update merges only) ─────────
  # Uses OIDC trusted publishing — no NPM_TOKEN needed.
  # Configure at: https://www.npmjs.com/package/@alejoamiras/tee-rex/access
  publish-sdk:
    name: Publish SDK
    needs: nextnet-check
    if: "github.event_name == 'workflow_dispatch' || startsWith(github.event.head_commit.message, 'chore: update @aztec/')"
    uses: ./.github/workflows/_publish-sdk.yml
    secrets: inherit
    with:
      dist_tag: spartan
      latest: true

  # ── Post-deploy validation against nextnet ───────────────────────
  # continue-on-error: nextnet is an external service we don't control.
  # Deploys succeed independently; this job is best-effort validation.
  validate-prod:
    name: Validate Prod (nextnet)
    needs: [changes, deploy-tee, deploy-prover, deploy-app]
    if: "!cancelled() && (needs.changes.outputs.servers == 'true' || needs.changes.outputs.app == 'true')"
    continue-on-error: true
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lock') }}
          restore-keys: ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Install SSM plugin
        run: |
          curl -sL "https://s3.amazonaws.com/session-manager-downloads/plugin/latest/ubuntu_64bit/session-manager-plugin.deb" \
            -o /tmp/session-manager-plugin.deb
          sudo dpkg -i /tmp/session-manager-plugin.deb

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Start SSM tunnel to prod prover
        run: |
          aws ssm start-session \
            --target "${{ secrets.PROD_PROVER_INSTANCE_ID }}" \
            --document-name AWS-StartPortForwardingSession \
            --parameters '{"portNumber":["80"],"localPortNumber":["4002"]}' &
          echo "PROVER_TUNNEL_PID=$!" >> "$GITHUB_ENV"

          echo "Waiting for prover SSM tunnel..."
          for i in $(seq 1 30); do
            if curl -sf http://localhost:4002/attestation > /dev/null 2>&1; then
              echo "Prover SSM tunnel ready (attempt $i)"
              exit 0
            fi
            sleep 2
          done
          echo "Prover SSM tunnel failed to connect after 60s"
          exit 1

      - name: Start SSM tunnel to prod TEE
        run: |
          aws ssm start-session \
            --target "${{ secrets.PROD_TEE_INSTANCE_ID }}" \
            --document-name AWS-StartPortForwardingSession \
            --parameters '{"portNumber":["4000"],"localPortNumber":["4001"]}' &
          echo "TEE_TUNNEL_PID=$!" >> "$GITHUB_ENV"

          echo "Waiting for TEE SSM tunnel..."
          for i in $(seq 1 30); do
            if curl -sf http://localhost:4001/attestation > /dev/null 2>&1; then
              echo "TEE SSM tunnel ready (attempt $i)"
              exit 0
            fi
            sleep 2
          done
          echo "TEE SSM tunnel failed to connect after 60s"
          exit 1

      - name: Install Playwright browsers
        run: bunx playwright install --with-deps chromium

      - name: Run app fullstack E2E against nextnet
        env:
          AZTEC_NODE_URL: https://nextnet.aztec-labs.com
          PROVER_URL: http://localhost:4002
          TEE_URL: http://localhost:4001
        run: bunx playwright test --project=fullstack --workers=1 e2e/demo.fullstack.spec.ts
        working-directory: packages/app

      - name: Cleanup SSM tunnels
        if: always()
        run: |
          kill $PROVER_TUNNEL_PID 2>/dev/null || true
          kill $TEE_TUNNEL_PID 2>/dev/null || true
