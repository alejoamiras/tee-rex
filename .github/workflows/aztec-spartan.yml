name: Aztec Spartan Update

on:
  schedule:
    - cron: "0 8 * * *" # 08:00 UTC daily
  workflow_dispatch:
    inputs:
      version:
        description: "Force specific version (leave empty for auto-detect)"
        required: false
        type: string

concurrency:
  group: aztec-spartan
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

jobs:
  # ── Job 1: Check if a newer spartan exists ──────────────────────────
  check-update:
    name: Check for new spartan
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      needs_update: ${{ steps.check.outputs.needs_update }}
      new_version: ${{ steps.check.outputs.new_version }}
      current_version: ${{ steps.check.outputs.current_version }}
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Check spartan version
        id: check
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            CURRENT=$(bun -e "console.log(JSON.parse(require('fs').readFileSync('packages/sdk/package.json','utf8')).devDependencies['@aztec/aztec.js'])")
            echo "needs_update=true" >> "$GITHUB_OUTPUT"
            echo "new_version=${{ inputs.version }}" >> "$GITHUB_OUTPUT"
            echo "current_version=$CURRENT" >> "$GITHUB_OUTPUT"
            echo "Forced update to ${{ inputs.version }} (current: $CURRENT)"
          else
            RESULT=$(bun scripts/check-aztec-spartan.ts)
            echo "$RESULT" | jq .
            NEEDS=$(echo "$RESULT" | jq -r .needsUpdate)
            LATEST=$(echo "$RESULT" | jq -r .latest)
            CURRENT=$(echo "$RESULT" | jq -r .current)
            echo "needs_update=$NEEDS" >> "$GITHUB_OUTPUT"
            echo "new_version=$LATEST" >> "$GITHUB_OUTPUT"
            echo "current_version=$CURRENT" >> "$GITHUB_OUTPUT"
            if [ "$NEEDS" = "true" ]; then
              echo "New spartan available: $CURRENT → $LATEST"
            else
              echo "Already up to date at $CURRENT"
            fi
          fi

  # ── Job 2: Update deps, commit, push ────────────────────────────────
  update:
    name: Update & push
    needs: check-update
    if: needs.check-update.outputs.needs_update == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      NEW_VERSION: ${{ needs.check-update.outputs.new_version }}
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-spartan-${{ needs.check-update.outputs.new_version }}
          restore-keys: |
            ${{ runner.os }}-bun-spartan-
            ${{ runner.os }}-bun-

      - name: Update @aztec/* versions
        run: bun scripts/update-aztec-version.ts $NEW_VERSION

      - name: Install dependencies with new versions
        run: bun install

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          BRANCH="chore/aztec-spartan-${NEW_VERSION}"

          # If the branch already exists on the remote, skip — a prior run
          # already pushed it. Force-pushing would orphan the commit that
          # CI workflows are running against, causing the PR to show no checks.
          if git ls-remote --exit-code origin "refs/heads/$BRANCH" > /dev/null 2>&1; then
            echo "Branch $BRANCH already exists on remote — skipping push"
            exit 0
          fi

          git checkout -b "$BRANCH"
          git add packages/*/package.json bun.lock
          git commit -m "chore: update @aztec/* to ${NEW_VERSION}"
          git push -u origin "$BRANCH"

  # ── Job 3: Create PR with label + auto-merge ───────────────────────
  create-pr:
    name: Create PR
    needs: [check-update, update]
    if: needs.update.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    env:
      GH_TOKEN: ${{ secrets.PAT_TOKEN }}
      NEW_VERSION: ${{ needs.check-update.outputs.new_version }}
      CURRENT_VERSION: ${{ needs.check-update.outputs.current_version }}
    steps:
      - uses: actions/checkout@v4

      - name: Create or update PR
        run: |
          BRANCH="chore/aztec-spartan-${NEW_VERSION}"
          TITLE="chore: update @aztec/* to ${NEW_VERSION}"

          BODY="$(cat <<'EOF'
          ## Aztec Spartan Update

          Automated dependency bump. PR CI runs all tests (unit, e2e, TEE).
          Auto-merge enabled — will merge when all required checks pass.

          [Workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ---
          *Automated by [Aztec Spartan Update](${{ github.server_url }}/${{ github.repository }}/actions/workflows/aztec-spartan.yml) workflow.*
          EOF
          )"

          # Check if PR already exists
          EXISTING_PR=$(gh pr list --head "$BRANCH" --json number --jq '.[0].number' 2>/dev/null || echo "")

          if [ -n "$EXISTING_PR" ]; then
            echo "Updating existing PR #$EXISTING_PR"
            gh pr edit "$EXISTING_PR" --title "$TITLE" --body "$BODY"
          else
            echo "Creating new PR"
            gh pr create \
              --head "$BRANCH" \
              --base main \
              --title "$TITLE" \
              --body "$BODY"
          fi

          # Get PR number
          PR_NUM=$(gh pr list --head "$BRANCH" --json number --jq '.[0].number')

          # Add label (triggers infra.yml — combined TEE + Remote deploy + e2e)
          gh pr edit "$PR_NUM" --add-label "test-infra" 2>/dev/null || true

          # Enable auto-merge (merges when required status checks pass)
          gh pr merge "$PR_NUM" --auto --squash --delete-branch
