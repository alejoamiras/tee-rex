name: _App E2E (reusable)

on:
  workflow_call:
    inputs:
      ref:
        description: Git ref to checkout
        required: false
        type: string
        default: ""
      test_script:
        description: "Package script to run (e.g. test:e2e:local-network or test:e2e:smoke)"
        required: false
        type: string
        default: "test:e2e:smoke"
      tee_url:
        description: TEE URL (enables TEE tests via SSM tunnel when set)
        required: false
        type: string
        default: ""
      aztec_node_url:
        description: Aztec node URL (skips local CLI install when not localhost)
        required: false
        type: string
        default: "http://localhost:8080"
      prover_url:
        description: Prover URL (skips local server start when not localhost)
        required: false
        type: string
        default: "http://localhost:4000"
      setup_prover_tunnel:
        description: Set up SSM tunnel to deployed prover instance
        required: false
        type: boolean
        default: false
      instance_id:
        description: EC2 instance ID for SSM tunnels (overrides secret)
        required: false
        type: string
        default: ""

jobs:
  e2e-app:
    name: App E2E (${{ inputs.test_script }})
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || github.ref }}

      # ── SSM Tunnels (TEE and/or prover) ──────────────────────────
      - name: Install SSM plugin
        if: inputs.tee_url != '' || inputs.setup_prover_tunnel
        run: |
          curl -sL "https://s3.amazonaws.com/session-manager-downloads/plugin/latest/ubuntu_64bit/session-manager-plugin.deb" \
            -o /tmp/session-manager-plugin.deb
          sudo dpkg -i /tmp/session-manager-plugin.deb

      - name: Configure AWS credentials
        if: inputs.tee_url != '' || inputs.setup_prover_tunnel
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Start SSM tunnel to TEE
        if: inputs.tee_url != ''
        run: |
          aws ssm start-session \
            --target "${{ inputs.instance_id }}" \
            --document-name AWS-StartPortForwardingSession \
            --parameters '{"portNumber":["4000"],"localPortNumber":["4001"]}' &
          echo "TEE_TUNNEL_PID=$!" >> "$GITHUB_ENV"

          echo "Waiting for TEE SSM tunnel..."
          for i in $(seq 1 30); do
            if curl -sf --max-time 5 http://localhost:4001/attestation > /dev/null 2>&1; then
              echo "TEE SSM tunnel ready (attempt $i)"
              exit 0
            fi
            sleep 2
          done
          echo "TEE SSM tunnel failed to connect after 60s"
          exit 1

      - name: Start SSM tunnel to prover
        if: inputs.setup_prover_tunnel
        run: |
          aws ssm start-session \
            --target "${{ inputs.instance_id }}" \
            --document-name AWS-StartPortForwardingSession \
            --parameters '{"portNumber":["80"],"localPortNumber":["4002"]}' &
          echo "PROVER_TUNNEL_PID=$!" >> "$GITHUB_ENV"

          echo "Waiting for prover SSM tunnel..."
          for i in $(seq 1 30); do
            if curl -sf --max-time 5 http://localhost:4002/attestation > /dev/null 2>&1; then
              echo "Prover SSM tunnel ready (attempt $i)"
              exit 0
            fi
            sleep 2
          done
          echo "Prover SSM tunnel failed to connect after 60s"
          exit 1

      # ── Setup & Run ───────────────────────────────────────────────
      - uses: ./.github/actions/setup-aztec
        with:
          skip_cli: ${{ inputs.aztec_node_url != 'http://localhost:8080' }}

      - name: Install Playwright browsers
        run: bunx playwright install --with-deps chromium

      - uses: ./.github/actions/start-services
        with:
          aztec_node_url: ${{ inputs.aztec_node_url }}
          prover_url: ${{ inputs.prover_url }}

      - name: Run E2E tests
        env:
          TEE_URL: ${{ inputs.tee_url }}
          AZTEC_NODE_URL: ${{ inputs.aztec_node_url }}
          PROVER_URL: ${{ inputs.prover_url }}
        run: bun run --cwd packages/app ${{ inputs.test_script }}

      - name: Upload Aztec logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: aztec-node-logs-app
          path: /tmp/aztec-node.log
          if-no-files-found: ignore
          retention-days: 7

      - name: Cleanup SSM tunnels
        if: always()
        run: |
          kill "$TEE_TUNNEL_PID" 2>/dev/null || true
          kill "$PROVER_TUNNEL_PID" 2>/dev/null || true
