name: _App Fullstack E2E (reusable)

on:
  workflow_call:
    inputs:
      ref:
        description: Git ref to checkout
        required: false
        type: string
        default: ""
      tee_url:
        description: TEE URL (enables TEE tests via SSM tunnel when set)
        required: false
        type: string
        default: ""
      aztec_node_url:
        description: Aztec node URL (skips local CLI install when not localhost)
        required: false
        type: string
        default: "http://localhost:8080"

jobs:
  e2e-app:
    name: App Fullstack E2E
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || github.ref }}

      # ── SSM Tunnel (only when TEE requested) ──────────────────────
      - name: Install SSM plugin
        if: inputs.tee_url != ''
        run: |
          curl -sL "https://s3.amazonaws.com/session-manager-downloads/plugin/latest/ubuntu_64bit/session-manager-plugin.deb" \
            -o /tmp/session-manager-plugin.deb
          sudo dpkg -i /tmp/session-manager-plugin.deb

      - name: Configure AWS credentials
        if: inputs.tee_url != ''
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Start SSM tunnel
        if: inputs.tee_url != ''
        run: |
          aws ssm start-session \
            --target "${{ secrets.TEE_INSTANCE_ID }}" \
            --document-name AWS-StartPortForwardingSession \
            --parameters '{"portNumber":["4000"],"localPortNumber":["4001"]}' &

          echo "Waiting for SSM tunnel..."
          for i in $(seq 1 30); do
            if curl -sf http://localhost:4001/attestation > /dev/null 2>&1; then
              echo "SSM tunnel ready (attempt $i)"
              exit 0
            fi
            sleep 2
          done
          echo "SSM tunnel failed to connect after 60s"
          exit 1

      # ── Setup & Run ───────────────────────────────────────────────
      - uses: ./.github/actions/setup-aztec
        with:
          skip_cli: ${{ inputs.aztec_node_url != 'http://localhost:8080' }}

      - name: Install Playwright browsers
        run: bunx playwright install --with-deps chromium

      - uses: ./.github/actions/start-services
        with:
          aztec_node_url: ${{ inputs.aztec_node_url }}

      - name: Run fullstack E2E tests
        env:
          TEE_URL: ${{ inputs.tee_url }}
          AZTEC_NODE_URL: ${{ inputs.aztec_node_url }}
        run: bun run --cwd packages/app test:e2e:fullstack
