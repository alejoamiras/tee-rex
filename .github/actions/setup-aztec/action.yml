name: Setup Aztec
description: Install Bun, Foundry, and Aztec CLI. Version auto-detected from packages/sdk/package.json.

inputs:
  skip_cli:
    description: Skip Foundry + Aztec CLI install (use when targeting a remote Aztec node)
    required: false
    default: "false"

runs:
  using: composite
  steps:
    - uses: oven-sh/setup-bun@v2
      with:
        bun-version: latest

    - uses: actions/cache@v4
      with:
        path: ~/.bun/install/cache
        key: ${{ runner.os }}-bun-${{ hashFiles('bun.lock') }}
        restore-keys: ${{ runner.os }}-bun-

    - run: bun install --frozen-lockfile
      shell: bash

    - name: Detect Aztec version
      if: inputs.skip_cli != 'true'
      id: detect
      shell: bash
      run: |
        VERSION=$(bun -e "console.log(JSON.parse(require('fs').readFileSync('packages/sdk/package.json','utf8')).devDependencies['@aztec/aztec.js'])")
        echo "Aztec version: $VERSION"
        echo "version=$VERSION" >> "$GITHUB_OUTPUT"

    - name: Install Node.js 24
      if: inputs.skip_cli != 'true'
      uses: actions/setup-node@v6
      with:
        node-version: 24

    - name: Install Foundry
      if: inputs.skip_cli != 'true'
      uses: foundry-rs/foundry-toolchain@v1

    - name: Cache Aztec CLI
      if: inputs.skip_cli != 'true'
      id: cache-aztec
      uses: actions/cache@v4
      with:
        path: ~/.aztec/versions/${{ steps.detect.outputs.version }}
        key: ${{ runner.os }}-aztec-${{ steps.detect.outputs.version }}

    - name: Install Aztec CLI
      if: inputs.skip_cli != 'true' && steps.cache-aztec.outputs.cache-hit != 'true'
      shell: bash
      run: |
        export CI=1
        export FOUNDRY_DIR="$HOME/.foundry"
        curl -fsSL "https://install.aztec.network/${{ steps.detect.outputs.version }}/install" \
          | VERSION=${{ steps.detect.outputs.version }} bash
        ls -la ~/.aztec/versions/${{ steps.detect.outputs.version }}/bin/

    - name: Update PATH
      if: inputs.skip_cli != 'true'
      shell: bash
      run: |
        echo "$HOME/.aztec/versions/${{ steps.detect.outputs.version }}/bin" >> $GITHUB_PATH
        echo "$HOME/.aztec/versions/${{ steps.detect.outputs.version }}/node_modules/.bin" >> $GITHUB_PATH
